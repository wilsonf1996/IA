<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financeiro</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            text-align: center;
            margin: 20px;
            background-image: url('https://raw.githubusercontent.com/wilsonf1996/index.html/main/DALL%C2%B7E%202023-12-23%2013.03.50%20-%20mpressionante%20imagem%20de%20fundo%20de%20tela%20para%20aplicativo%20web%20de%20engenheiro%20civil%20fundo%20branco%2C%20hiper-realista%20e%20com%20designer%20moderno.%20A%20imagem%20deve%20ser%20r.png');
            background-size: cover;
            background-position: center;
            -webkit-background-size: cover;
            -moz-background-size: cover;
            -o-background-size: cover;
        }

        h1 {
            color: #333;
        }

        table {
            width: 100%;
            margin: 20px auto;
            border-collapse: collapse;
            overflow-y: scroll;
            max-height: 400px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        button {
            padding: 10px;
            font-size: 16px;
            margin: 0 10px;
        }

        input {
            width: 80%;
            margin: 10px 0;
        }

        #expenses-table {
            overflow-y: auto;
        }
    </style>
    <!-- Carregue a biblioteca do Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.2.0/dist/pdf-lib.js"></script>
</head>
<body>
    <h1>Financeiro</h1>

    <table id="expenses-table">
        <thead>
            <tr>
                <th>Data e Hora</th>
                <th>Descrição</th>
                <th>Tipo</th>
                <th>Valor (R$)</th>
                <th>Ações</th>
            </tr>
        </thead>
        <tbody id="expenses-body"></tbody>
    </table>
    <input type="text" id="expense-description" placeholder="Descrição do Gasto/Receita">
    <input type="number" id="expense-amount" placeholder="Valor (R$)">
    <input type="datetime-local" id="expense-date" placeholder="Data do Gasto/Receita">
    <label for="expense-type">Tipo:</label>
    <select id="expense-type">
        <option value="expense">Despesa</option>
        <option value="income">Receita</option>
    </select>
    <button id="createOrUpdateExpenseBtn">Registrar Gasto/Receita</button>
    <button id="generatePDFBtn">Gerar Relatório em PDF</button>
    <button id="generateReportBtn">Gerar Relatório</button>
    <button id="goToHomePageBtn">Voltar para a Página Principal</button>
    <script>
        // Função para verificar se a biblioteca jsPDF está carregada
        function isJsPDFLoaded() {
            return typeof jsPDF !== 'undefined';
        }

        // Função para carregar a biblioteca jsPDF
        function loadAndGeneratePDF() {
            loadJS('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js', function () {
                if (typeof jsPDF !== 'undefined') {
                    generatePDF();
                } else {
                    console.error('A biblioteca jsPDF não foi carregada corretamente.');
                }
            });
        }

        function loadJS(url, callback) {
            var script = document.createElement('script');
            script.type = 'text/javascript';
            script.src = url;
            script.onreadystatechange = callback;
            script.onload = callback;
            document.head.appendChild(script);
        }

        // Configuração do Firebase
        const firebaseConfig = {
            const firebaseConfig = {
            apiKey: "AIzaSyAIp-rFuZZsBCNVJ3pSge4TE-XUuwYygrI",
            authDomain: "agenda-6accc.firebaseapp.com",
            databaseURL: "https://agenda-6accc-default-rtdb.firebaseio.com",
            projectId: "agenda-6accc",
            storageBucket: "agenda-6accc.appspot.com",
            messagingSenderId: "794262176773",
            appId: "1:794262176773:web:c4e3837b29f635d5dc086c",
            measurementId: "G-CVBQ54PERH"
        };

        // Inicialização do Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Variável para armazenar despesas e receitas
        let expenses = [];
        // Função principal para inicializar despesas e configurar eventos
        function initializeApp() {
            initExpenses();
            setupEventListeners();
        }

        // Função para configurar os ouvintes de eventos nos botões
        function setupEventListeners() {
            document.getElementById('createOrUpdateExpenseBtn').addEventListener('click', handleCreateOrUpdateExpense);
            document.getElementById('generatePDFBtn').addEventListener('click', handleGeneratePDF);
            document.getElementById('generateReportBtn').addEventListener('click', handleGenerateReport);
            document.getElementById('goToHomePageBtn').addEventListener('click', handleGoToHomePage);
        }

        // Função para lidar com a criação ou atualização de despesas
        async function handleCreateOrUpdateExpense() {
            try {
                const description = document.getElementById('expense-description').value;
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const date = document.getElementById('expense-date').value;
                const type = document.getElementById('expense-type').value;

                if (!isValidExpense(description, amount, date)) {
                    alert('Por favor, preencha todos os campos corretamente.');
                    return;
                }

                const existingExpenseIndex = expenses.findIndex(expense => expense.dateTime === date && expense.type === type);

                if (existingExpenseIndex !== -1) {
                    // Editar despesa ou receita existente
                    const editedType = prompt('Editar Tipo (expense ou income):', expenses[existingExpenseIndex].type);
                    expenses[existingExpenseIndex].description = description;
                    expenses[existingExpenseIndex].amount = amount;
                    expenses[existingExpenseIndex].type = editedType;
                } else {
                    // Adicionar nova despesa ou receita
                    const newExpense = {
                        dateTime: date,
                        description,
                        amount,
                        type
                    };
                    expenses.push(newExpense);
                }

                await database.ref('/expenses').set(expenses);
            } catch (error) {
                console.error('Erro ao criar ou atualizar despesa:', error);
                alert('Erro ao criar ou atualizar despesa. Consulte o console para obter detalhes.');
            }
        }

        // Funções restantes e chamada para inicializar o aplicativo omitidas para brevidade
        function initExpenses() {
    const expensesRef = database.ref('/expenses');

    expensesRef.on('value', (snapshot) => {
        const expensesData = snapshot.val();
        expenses = expensesData ? Object.values(expensesData) : [];
        loadExpensesTable(expenses);
    });
}

function loadExpensesTable(expenses) {
    const tableBody = document.getElementById('expenses-body');
    tableBody.innerHTML = "";

    if (Array.isArray(expenses)) {
        expenses.forEach((expense, index) => {
            const row = tableBody.insertRow();
            const cellDateTime = row.insertCell(0);
            const cellDescription = row.insertCell(1);
            const cellType = row.insertCell(2);
            const cellAmount = row.insertCell(3);
            const cellActions = row.insertCell(4);

            const formattedDate = new Date(expense.dateTime).toLocaleString('pt-BR');

            cellDateTime.textContent = formattedDate;
            cellDescription.textContent = expense.description;
            cellType.textContent = expense.type === 'expense' ? 'Despesa' : 'Receita';
            cellAmount.textContent = `R$ ${expense.amount.toFixed(2)}`;

            const editButton = document.createElement('button');
            editButton.textContent = 'Editar';
            editButton.onclick = () => editExpense(index);

            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Excluir';
            deleteButton.onclick = () => deleteExpense(expense.dateTime);

            cellActions.appendChild(editButton);
            cellActions.appendChild(deleteButton);
        });
    } else {
        console.error("Dados de despesas inválidos:", expenses);
    }
}

function createOrUpdateExpense() {
    const description = document.getElementById('expense-description').value;
    const amount = parseFloat(document.getElementById('expense-amount').value);
    const date = document.getElementById('expense-date').value;
    const type = document.getElementById('expense-type').value;

    if (!isValidExpense(description, amount, date)) {
        alert('Por favor, preencha todos os campos corretamente.');
        return;
    }

    const existingExpenseIndex = expenses.findIndex(expense => expense.dateTime === date && expense.type === type);

    if (existingExpenseIndex !== -1) {
        // Editar despesa ou receita existente
        const editedType = prompt('Editar Tipo (expense ou income):', expenses[existingExpenseIndex].type);
        expenses[existingExpenseIndex].description = description;
        expenses[existingExpenseIndex].amount = amount;
        expenses[existingExpenseIndex].type = editedType;
    } else {
        // Adicionar nova despesa ou receita
        const newExpense = {
            dateTime: date,
            description,
            amount,
            type
        };
        expenses.push(newExpense);
    }

    database.ref('/expenses').set(expenses);
}

function isValidExpense(description, amount, date) {
    return description.trim() !== '' && !isNaN(amount) && date !== '';
}

function editExpense(index) {
    const editedDescription = prompt('Editar Descrição:', expenses[index].description);
    const editedAmount = parseFloat(prompt('Editar Valor (R$):', expenses[index].amount.toFixed(2)));
    const editedType = prompt('Editar Tipo (expense ou income):', expenses[index].type);
    const editedDateTime = prompt('Editar Data e Hora (AAAA-MM-DDTHH:mm):', expenses[index].dateTime);

    if (isValidExpense(editedDescription, editedAmount, editedDateTime)) {
        expenses[index].description = editedDescription;
        expenses[index].amount = editedAmount;
        expenses[index].type = editedType;
        expenses[index].dateTime = editedDateTime;

        database.ref('/expenses').set(expenses);
    } else {
        alert('Edição cancelada ou valores inválidos.');
    }
}

function deleteExpense(dateTime) {
    const confirmDelete = confirm('Tem certeza que deseja excluir este item?');

    if (confirmDelete) {
        const indexToDelete = expenses.findIndex(expense => expense.dateTime === dateTime);
        expenses.splice(indexToDelete, 1);

        database.ref('/expenses').set(expenses);
    }
}

async function generatePDF() {
    try {
        // Crie um documento PDF usando a API pdf-lib
        const pdfDoc = await PDFLib.PDFDocument.create();

        // Adicione uma página
        const page = pdfDoc.addPage();
        const { width, height } = page.getSize();
        const fontSize = 12;
        const font = await pdfDoc.embedFont(PDFLib.Font.Courier); // Adicione esta linha para carregar a fonte

        // Adicione uma camada retangular branca ao fundo da página
        page.drawRectangle({
            x: 0,
            y: 0,
            width: width,
            height: height,
            color: PDFLib.rgb(1, 1, 1),  // Corrigido para valores entre 0 e 1
        });

        // Adicione a lista de despesas e receitas à página
        let y = height - 30;
        const headerText = 'Data e Hora\tDescrição\tTipo\tValor (R$)';
        page.drawText(headerText, { x: 50, y, fontSize, font, color: PDFLib.rgb(0, 0, 0) });

        expenses.forEach(expense => {
            y -= 15;
            const formattedExpense = `${new Date(expense.dateTime).toLocaleString('pt-BR')}\t${expense.description}\t${expense.type === 'expense' ? 'Despesa' : 'Receita'}\tR$ ${expense.amount.toFixed(2)}`;
            page.drawText(formattedExpense, { x: 50, y, fontSize, font, color: PDFLib.rgb(0, 0, 0) });
        });

        // Adicione os resumos de despesa, receita e balanço
        y -= 30;
        const totalExpenseText = `Total de Despesas: R$ ${expenses.reduce((total, expense) => total + (expense.type === 'expense' ? expense.amount : 0), 0).toFixed(2)}`;
        const totalRevenueText = `Total de Receitas: R$ ${expenses.reduce((total, expense) => total + (expense.type === 'income' ? expense.amount : 0), 0).toFixed(2)}`;
        const balanceText = `Balanço: R$ ${(expenses.reduce((total, expense) => total + (expense.type === 'income' ? expense.amount : 0), 0) - expenses.reduce((total, expense) => total + (expense.type === 'expense' ? expense.amount : 0), 0)).toFixed(2)}`;

        page.drawText(totalExpenseText, { x: 50, y, fontSize, font, color: PDFLib.rgb(0, 0, 0) });
        y -= 15;
        page.drawText(totalRevenueText, { x: 50, y, fontSize, font, color: PDFLib.rgb(0, 0, 0) });
        y -= 15;
        page.drawText(balanceText, { x: 50, y, fontSize, font, color: PDFLib.rgb(0, 0, 0) });

        // Gere o PDF como Blob
        const pdfBytes = await pdfDoc.save();

        // Crie um URL para o Blob
        const pdfUrl = URL.createObjectURL(new Blob([pdfBytes]));

        // Crie um link para download
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfUrl;
        downloadLink.download = 'relatorio.pdf';
        downloadLink.textContent = 'Baixar Relatório em PDF';

        // Adicione o link à página
        document.body.appendChild(downloadLink);

        // Simule o clique no link para iniciar o download
        downloadLink.click();

        // Remova o link da página
        document.body.removeChild(downloadLink);

    } catch (error) {
        console.error('Erro ao gerar PDF:', error);
        alert('Erro ao gerar PDF. Consulte o console para obter detalhes.');
    }
}

function generateExpensesReport(pdfContent) {
    pdfContent.push(['Relatório de Despesas']);
    pdfContent.push(['Data e Hora', 'Descrição', 'Tipo', 'Valor (R$)']);
    expenses.filter(expense => expense.type === 'expense').forEach(expense => pdfContent.push([
        new Date(expense.dateTime).toLocaleString('pt-BR'),
        expense.description,
        'Despesa',
        `R$ ${expense.amount.toFixed(2)}`
    ]));
}

function generateIncomeReport(pdfContent) {
    const startDate = prompt('Informe a data de início (DD/MM/AAAA):');
    const endDate = prompt('Informe a data de fim (DD/MM/AAAA):');

    if (startDate && endDate) {
        const filteredIncome = expenses.filter(expense => {
            return expense.type === 'income' &&
                new Date(expense.dateTime).toLocaleDateString('pt-BR') >= startDate &&
                new Date(expense.dateTime).toLocaleDateString('pt-BR') <= endDate;
        });

        pdfContent.push(['Relatório de Receitas']);
        pdfContent.push(['Data e Hora', 'Descrição', 'Tipo', 'Valor (R$)']);
        filteredIncome.forEach(income => pdfContent.push([
            new Date(income.dateTime).toLocaleString('pt-BR'),
            income.description,
            'Receita',
            `R$ ${income.amount.toFixed(2)}`
        ]));
    } else {
        alert('Período inválido ou não informado.');
    }
}

function generateBalanceReport(pdfContent) {
    const startDate = prompt('Informe a data de início (DD/MM/AAAA):');
    const endDate = prompt('Informe a data de fim (DD/MM/AAAA):');

    if (startDate && endDate) {
        const filteredExpenses = expenses.filter(expense => {
            return new Date(expense.dateTime).toLocaleDateString('pt-BR') >= startDate &&
                new Date(expense.dateTime).toLocaleDateString('pt-BR') <= endDate;
        });

        const totalIncome = filteredExpenses.reduce((sum, expense) => {
            return expense.type === 'income' ? sum + expense.amount : sum;
        }, 0);

        const totalExpenses = filteredExpenses.reduce((sum, expense) => {
            return expense.type === 'expense' ? sum + expense.amount : sum;
        }, 0);

        const balance = totalIncome - totalExpenses;

        pdfContent.push(['Relatório de Balanço']);
        pdfContent.push(['Período', 'Total de Receitas (R$)', 'Total de Despesas (R$)', 'Saldo (R$)']);
        pdfContent.push([`${startDate} a ${endDate}`, totalIncome.toFixed(2), totalExpenses.toFixed(2), balance.toFixed(2)]);
    } else {
        alert('Período inválido ou não informado.');
    }
}

function generateReport() {
    const pdfContent = [];
    generateExpensesReport(pdfContent);
    generateIncomeReport(pdfContent);
    generateBalanceReport(pdfContent);

    if (pdfContent.length > 0) {
        // Gere o PDF como Blob
        const pdfBytes = await generateReportPDF(pdfContent);

        // Crie um URL para o Blob
        const pdfUrl = URL.createObjectURL(new Blob([pdfBytes]));

        // Crie um link para download
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfUrl;
        downloadLink.download = 'relatorio.pdf';
        downloadLink.textContent = 'Baixar Relatório em PDF';

        // Adicione o link à página
        document.body.appendChild(downloadLink);

        // Simule o clique no link para iniciar o download
        downloadLink.click();

        // Remova o link da página
        document.body.removeChild(downloadLink);
    }
}

function goToHomePage() {
    window.location.href = 'index.html';
}

        initializeApp();
    </script>
</body>
</html>

