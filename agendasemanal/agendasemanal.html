<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Agenda Semanal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.css" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.24.0/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.10.2/fullcalendar.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
</head>

<body>
    <h1>Minha Agenda Semanal</h1>

    <div id="calendar"></div>

    <div id="schedule-table-container"></div>

    <script>
        // Configuração do Firebase
        const firebaseConfig = {
            // Insira suas configurações do Firebase aqui
        };

        // Inicialização do Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Estrutura de atividades
        let activities = [];

        // Função para inicializar o calendário
        function initCalendar() {
            $('#calendar').fullCalendar({
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'month,agendaWeek,agendaDay'
                },
                defaultView: 'agendaWeek',
                editable: true,
                events: loadActivities,
                eventDrop: updateActivity
            });
        }

        // Função para carregar as atividades no calendário
        function loadActivities(start, end, timezone, callback) {
            const scheduleRef = database.ref('/schedule');
            scheduleRef.on('value', (snapshot) => {
                activities = snapshot.val() || [];
                const events = activities.map(activity => {
                    return {
                        id: activity.id,
                        title: activity.name,
                        start: moment(activity.dateTime).toISOString(),
                        end: moment(activity.dateTime).add(30, 'minutes').toISOString()
                    };
                });
                callback(events);
            });
        }

        // Função para adicionar ou editar uma atividade
        function updateActivity(event) {
            const existingActivity = activities.find(activity => activity.id === event.id);

            if (existingActivity) {
                // Atualizar atividade existente
                existingActivity.dateTime = moment(event.start).toISOString();
            } else {
                // Adicionar nova atividade
                const newActivity = {
                    id: generateId(),
                    name: event.title,
                    dateTime: moment(event.start).toISOString()
                };
                activities.push(newActivity);
            }

            database.ref('/schedule').set(activities);
        }

        // Função para gerar um ID único
        function generateId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Função para construir a tabela de horários
        function buildScheduleTable() {
            const scheduleTableContainer = document.getElementById('schedule-table-container');
            scheduleTableContainer.innerHTML = '<h2>Tabela de Horários</h2>';
            scheduleTableContainer.innerHTML += '<table id="schedule-table" border="1"></table>';

            const scheduleTable = document.getElementById('schedule-table');
            scheduleTable.innerHTML = '<tr><th>Dia/Hora</th><th>Segunda</th><th>Terça</th><th>Quarta</th><th>Quinta</th><th>Sexta</th><th>Sábado</th><th>Domingo</th></tr>';

            for (let i = 0; i < 24; i++) {
                const row = scheduleTable.insertRow();
                const timeCell = row.insertCell(0);
                timeCell.textContent = `${i}:00 - ${i + 1}:00`;

                for (let j = 0; j < 7; j++) {
                    const dayCell = row.insertCell(j + 1);
                    const day = moment().isoWeekday(j + 1).startOf('day');
                    const hour = moment().hour(i).startOf('hour');
                    const dateTime = day.add(hour.diff(day, 'minutes'), 'minutes').toISOString();
                    const activity = getActivityByDateTime(dateTime);
                    const cellContent = activity ? `<div contenteditable="true">${activity.name}</div>` : '';
                    dayCell.innerHTML = cellContent;
                    dayCell.setAttribute('data-date-time', dateTime);
                    dayCell.addEventListener('blur', onCellBlur);
                }
            }
        }

        // Função para obter uma atividade com base na data e hora
        function getActivityByDateTime(dateTime) {
            return activities.find(activity => moment(activity.dateTime).toISOString() === dateTime);
        }

        // Função chamada quando uma célula perde o foco
        function onCellBlur(event) {
            const dateTime = event.currentTarget.getAttribute('data-date-time');
            const cellContent = event.currentTarget.innerHTML;
            const existingActivity = getActivityByDateTime(dateTime);

            if (existingActivity) {
                existingActivity.name = cellContent;
            } else {
                const newActivity = {
                    id: generateId(),
                    name: cellContent,
                    dateTime: dateTime
                };
                activities.push(newActivity);
            }

            database.ref('/schedule').set(activities);
        }

        // Ao carregar a página, inicialize o calendário e construa a tabela de horários
        document.addEventListener('DOMContentLoaded', function () {
            initCalendar();
            buildScheduleTable();
        });
    </script>
</body>

</html>


